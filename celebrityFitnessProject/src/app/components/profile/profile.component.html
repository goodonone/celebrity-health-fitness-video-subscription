<div class="pageContainer">

    <!-- Loading Spinner -->
    <!-- Shows during initial page load, replaced by main content when ready -->
    <ng-container *ngIf="!loadingComplete" class="spinnerContainer">
        <div class="spinner-overlay">
            <svg class="spinner" viewBox="0 0 50 50">
                <circle class="path" cx="25" cy="25" r="20" fill="none" stroke-width="5"></circle>
            </svg>
            <div class="spinner-text">Loading...</div>
        </div>
    </ng-container>
    
    <div class="flexContainer" [@fadeInOut]="loadingComplete">

        <!-- User greeting with tier-specific styling -->
        <!-- Shows different styling based on user's membership tier -->
        <div class="nameTier">
            <h1 class="profileNameTier tierOne" id="tierOne" *ngIf="tierOne" [ngClass]="{'firstTimeAnimation': firstTimeAnimation}"><span class="nameTierOne">Hi {{firstName}}!</span> You're {{currentUser.tier | uppercase}}</h1>
            <h1 class="profileNameTier tierTwo"  id="tierTwo" *ngIf="tierTwo" [ngClass]="{'firstTimeAnimation': firstTimeAnimation}"><span class="nameTierTwo">Hi {{firstName}}!</span> You are <span class="mobileTierTwo">{{currentUser.tier | uppercase}}</span> </h1>
            <h1 class="profileNameTier tierThree" id="tierThree" *ngIf="tierThree" [ngClass]="{'firstTimeAnimation': firstTimeAnimation}"><span class="nameTierThree">Hi {{firstName}}!</span> You are {{currentUser.tier | uppercase}}</h1>
            
            <!-- Down facing arrows on mobile only for better ux -->
            <div class="arrowContainer" [ngClass]="{'firstTimeAnimation': firstTimeAnimation, 'narrow': true}">
                
                <!-- Down arrows -->
                <div class="arrows">
                    <fa-icon [icon]="['fas', 'angle-down']" [ngClass]="{'narrow': true, 'arrow-size': true}" class="arrow-icon"></fa-icon>
                    <fa-icon [icon]="['fas', 'angle-down']" [ngClass]="{'narrow': true, 'arrow-size': true}" class="arrow-icon"></fa-icon>
                </div>

            </div>
        </div>

        <!-- Main profile container with card -->
        <div class="profileContainer">

            <!-- Cancel subscription overlay (conditionally shown) -->
            <div class="deleteProfileContainer" [class.active]="currentState === ProfileState.DeletingProfile">

                <!-- Warning message and confirmation buttons -->
                <div class="absoluteContainer" *ngIf="currentState === ProfileState.DeletingProfile">
                    <div class="cancelSubscription">
                        <img class="warningImg" src="assets/Images/Exclamation.svg">
                        <h1 class="deleteProfileText" [ngClass]="{'wide': true}">You are about to <span class="underline">Cancel Your Membership.</span> <br>You will Lose All Access to Plan Specific <br> Content & All Access to the Store. <br>  Proceeding will Delete All Traces of Your Profile.<br> This Step Cannot be Undone. <br> Proceed with Caution! <br><br> You will be missed.</h1>
                        <h1 class="deleteProfileText" [ngClass]="{'narrow': true}"> You are about to <br> <span class="underline">Cancel Your Membership.</span> <br>You will Lose All Access to Plan Specific Content & All Access to the Store. Proceeding will Delete All Traces of Your Profile.<br> This Step Cannot be Undone. <br> Proceed with Caution! <br><br> You will be missed.</h1>
                        <div class="cancelSubscriptionButtonContainer">
                            <button mat-button style="color:white" class="btn btn-backButton" type="submit" (click)="cancelAction()">Keep <br> Subscription</button>
                            <button mat-button style="color:red" class="btn btn-cancelSubscriptionButtonFinal" id="cancelSub" (click)="goodbye()" type="submit">{{buttonText}}</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main profile card with different States -->
            <fieldset id="deleteProfile" [class.active]="currentState === ProfileState.DeletingProfile" [disabled]="currentState === ProfileState.DeletingProfile">
           
            <mat-card class="profileInfo">
               <!-- Content changes based on Current State -->

                <div class="flexAllProfileData">

                    <!-- Profile picture container with image manipulation controls -->
                    <div class="profilePictureAndButtonsContainer">
                        <div class="profilePictureAndButtons">
                            <div class="profilePictureContainerForDragging" #container [ngClass]="{'draggable': canDrag(), 'is-dragging': isDragging, 'tablet': isTablet }">
                                
                                <!-- Loading overlay during image operations -->
                                <div class="loading-overlay" *ngIf="shouldShowLoadingOverlay">
                                    <mat-spinner class="loadingImagesSpinner" diameter="40" style="--mdc-circular-progress-active-indicator-color: white;"></mat-spinner>
                                    <p class="loadingImagesText">Loading...</p>
                                </div>

                                <!-- Image manipulation controls (zoom, drag, navigation) -->
                                <ng-container *ngIf="isControlsVisible()">
               
                                    <!-- Position instructions -->
                                    <p class="dragToCenter wide" *ngIf="(canDrag() && isImageUrlFilled()) || imageManagementService.hasAnyFirebaseImages() || (pictureForm.get('imgUrl')?.value && imageLoadedSuccessfully)" [ngClass]="{'fadeOut': isIconHovered, 'fadeIn': !isIconHovered }" [@fadeInControls]>DRAG <br> TO <br> POSITION</p>

                                    <!-- Zoom controls -->
                                    <div class="zoomButtons" *ngIf="(canDrag() && isImageUrlFilled()) || imageManagementService.hasAnyFirebaseImages() || (pictureForm.get('imgUrl')?.value && imageLoadedSuccessfully)" [@fadeInControls]>

                                        <!-- Zoom in/out buttons -->
                                        <fa-icon [icon]="['fas', 'minus']" class="zoomOut" [ngClass]="{'clicked': isOutClicked, 'disabled': zoomLevel <= minZoom}" 
                                        (pointerenter)="!isDisabled('minus') && onPointerEnter('minus')"
                                        (pointerdown)="onPointerDown('minus')" 
                                        (pointerup)="onPointerUp('minus')"
                                        (pointerleave)="onPointerLeave('minus')"
                                        (click)="zoomOut()"></fa-icon>
                                        <fa-icon [icon]="['fas', 'plus']" class="zoomIn" [ngClass]="{'clicked': isInClicked, 'disabled': zoomLevel >= maxZoom}" 
                                        (pointerenter)="!isDisabled('plus') && onPointerEnter('plus')"
                                        (pointerdown)="onPointerDown('plus')"
                                        (pointerup)="onPointerUp('plus')" 
                                        (pointerleave)="onPointerLeave('plus')"
                                        (click)="zoomIn()"></fa-icon>
                                    </div>

                                    <!-- Reset position button -->
                                    <p class="reset" *ngIf="(canDrag() && isImageUrlFilled()) || imageManagementService.hasAnyFirebaseImages() || (pictureForm.get('imgUrl')?.value && imageLoadedSuccessfully)"
                                        (pointerdown)="onPointerDown('reset')"
                                        (pointerenter)="!isDisabled('reset') && onPointerEnter('reset')"
                                        (pointerup)="onPointerUp('reset')" 
                                        (pointerleave)="onPointerLeave('reset')"
                                        [ngClass]="{'clicked': isResetClicked, 
                                        'disabled': isInDefaultPosition(), 
                                        'is-dragging': isDragging}"
                                        (click)="resetImagePositionAndZoom()"
                                        [@fadeInReset]="{value: 'enter', params: { finalOpacity: getResetControlOpacity() }}">RESET</p>

                                    <!-- Mobile version of drag instructions -->
                                    <p class="dragToCenter narrow"  *ngIf="(canDrag() && isImageUrlFilled()) || imageManagementService.hasAnyFirebaseImages() || (pictureForm.get('imgUrl')?.value && imageLoadedSuccessfully)" [ngClass]="{'narrow': true}" [@fadeInControls]>DRAG</p>

                                    <!-- Image navigation controls (previous/next) -->
                                    <div class="profile-image-navigation"  *ngIf="((canDrag() && isImageUrlFilled()) || imageManagementService.hasAnyFirebaseImages() || (pictureForm.get('imgUrl')?.value && imageLoadedSuccessfully))" [@fadeInControls]>    
                                        <fa-icon [icon]="['fas', 'chevron-left']" 
                                                    class="chevronLeft" 
                                                    (click)="previousImage()"
                                                    (mousedown)="onPointerDown('left')"
                                                    (mouseenter)="!isDisabled('left') && onPointerEnter('left'); onChevronEnter()"
                                                    (mouseup)="onPointerUp('left')" 
                                                    (mouseleave)="onPointerLeave('left'); onChevronLeave()"
                                                    [ngClass]="{'clicked': leftClicked}"
                                                    *ngIf="shouldShowNavigation()">
                                        </fa-icon>                                   
                                        <fa-icon [icon]="['fas', 'chevron-right']" 
                                                    class="chevronRight"
                                                    (click)="nextImage()"
                                                    (mousedown)="onPointerDown('right')"
                                                    (mouseenter)="!isDisabled('right') && onPointerEnter('right'); onChevronEnter()"
                                                    (mouseup)="onPointerUp('right')" 
                                                    (mouseleave)="onPointerLeave('right'); onChevronLeave()"
                                                    [ngClass]="{'clicked': rightClicked}"
                                                    *ngIf="shouldShowNavigation()">
                                        </fa-icon>

                                        <!-- Disabled Chevrons for Upload/Paste  -->
                                        <fa-icon [icon]="['fas', 'chevron-left']" 
                                                    class="chevronLeftDisabled" 
                                                    [ngClass]="{'disabled': !shouldShowNavigation()}"
                                                    *ngIf="!shouldShowNavigation()">
                                        </fa-icon>                           
                                        <fa-icon [icon]="['fas', 'chevron-right']" 
                                                    class="chevronRightDisabled"
                                                    [ngClass]="{'disabled': !shouldShowNavigation()}"
                                                    *ngIf="!shouldShowNavigation()">
                                        </fa-icon>
                                    </div>
                               
                                </ng-container>

                                    <!-- The actual profile picture display -->
                                    <mat-card class="profilePicture" id="profilePicture"
                                                [class.changing-picture]="currentState === ProfileState.ChangingPicture"
                                                [ngClass]="getProfileClasses()"
                                                (mousedown)="startDrag($event)"
                                                (mouseleave)="endDrag($event)"
                                                (touchstart)="startDrag($event)"
                                                (touchend)="endDrag($event)"
                                                (transitionend)="onSlideAnimationEnd($event)"
                                                #profileImg>

                                                <div class="image-container">
                                                    <!-- Current and next image containers for transitions -->

                                                    <!-- Current Image -->
                                                    <div class="image-wrapper"
                                                        [ngStyle]="imageStyles"
                                                        [@slideAnimation]="currentImageState"
                                                        *ngIf="isTransitioning">
                                                    </div>
                                            
                                                    <!-- Next Image -->
                                                    <div class="image-wrapper"
                                                        [ngStyle]="nextImageStyles"
                                                        [@slideAnimation]="nextImageState"
                                                        *ngIf="nextImageStyles">
                                                    </div>
                                                 </div>

                                                <!-- Circular navigation indicator for multiple images -->
                                                <div class="circular-nav-container" 
                                                    *ngIf="currentState === ProfileState.ChangingPicture && 
                                                           imageManagementService.getUserImagesSubject(userId).value.urls.length > 1 && 
                                                           !isLoadingImages && 
                                                           (currentUser.imgUrl || (imageManagementService.hasAnyFirebaseImages() && firebaseImageLoaded) || 
                                                           (pictureForm.get('imgUrl')?.value && imageLoadedSuccessfully))"
                                                    [class.visible]="isMobile || showSegments"
                                                    [@fadeInControls]="isMobile">

                                                    <!-- SVG segments for image indicators -->
                                                    <svg
                                                        class="progress-ring"
                                                        [attr.width]="circleSize"
                                                        [attr.height]="circleSize"
                                                        [attr.viewBox]="'0 0 ' + circleSize + ' ' + circleSize">
                                                        <ng-container *ngFor="let _ of imageManagementService.getUserImagesSubject(userId).value.urls; let i = index">
                                                                <path
                                                                    [attr.d]="getSegmentPath(i)"
                                                                    [attr.stroke]="getSegmentClass(i) === 'active' ? '#FFFFFF' : 'rgba(116, 115, 115, 0.8)'"
                                                                    [attr.stroke-width]="circleStrokeWidth"
                                                                    fill="none"
                                                                    stroke-linecap="round"
                                                                    [class]="getSegmentClass(i)"/>
                                                        </ng-container>
                                                    </svg>
                                                </div>

                                                <!-- Error and Avatar States -->
                                                <p class="imageNotFound" *ngIf="imageNotFound && currentUser.imgUrl && !shouldShowAvatar()">Image Not Found. <br> Please Contact Support!</p>
                                                <img class="avatar" 
                                                    src="assets/Images/avatar.png" 
                                                    *ngIf="shouldShowAvatar()"
                                                    [@fadeInImage]="(!currentUser.imgUrl && currentState === ProfileState.ChangingPicture && this.imageManagementService.hasAnyFirebaseImages()) ? imageState : 'visible'">
                                    </mat-card>
                                    
                            </div>

                            <!-- Profile picture action buttons -->
                            <div class="editProfileButtonsContainerIncludingPicture">

                                <!-- Add/Change/Delete picture buttons -->
                                <button mat-button style="color:white" class="btn btn-editPhotoButton" *ngIf="!currentUser.imgUrl && !imageManagementService.hasAnyFirebaseImages() && (currentState === ProfileState.Viewing || currentState === ProfileState.DeletingProfile)" (click)="changePicture()">Add Picture</button>
                                <button mat-button style="color:white" class="btn btn-editPhotoButton" *ngIf="(currentUser.imgUrl || imageManagementService.hasAnyFirebaseImages()) && (currentState === ProfileState.Viewing || currentState === ProfileState.DeletingProfile)" (click)="changePicture()">Change Picture</button>
                                <button mat-button style="color:white" class="btn btn-editPhotoButton deletePicture" *ngIf="((currentUser.imgUrl || imageManagementService.hasAnyFirebaseImages()) && currentState === ProfileState.ChangingPicture)"
                                        (click)="deleteCurrentImage()" [class.can-hover]="canHoverDelete" (mouseenter)="handlePointerEnter()" (mouseleave)="handlePointerLeave()">Delete Picture</button>
                                
                                <!-- Other profile action buttons for mobile -->
                                <button mat-button style="color:white" class="btn btn-editProfileButton" (click)="editProfile()" id="buttonDisappearEdit" [ngClass]="{'narrow': true}">Edit Profile</button>
                                <button mat-button style="color:white" class="btn btn-changePasswordButton"(click)="changePassword()" id="buttonDisappearEdit" [ngClass]="{'narrow': true}" [disabled]="profileForm.get('isGoogleAuth')?.value === true">Change Password</button>
                                <button mat-button style="color:white" class="btn btn-billingDetailsButton"id="buttonDisappearEdit" [ngClass]="{'narrow': true}">Billing Details</button>
                                <button mat-button style="color:white" class="btn btn-cancelSubscriptionButton" (click)="deleteProfile()" id="buttonDisappearEdit" [ngClass]="{'narrow': true}">Cancel Subscription</button>
                                <button mat-button style="color:white" class="btn btn-signOutButton" (click)="logOut()" id="buttonDisappearEdit" [ngClass]="{'narrow': true}">Log Out</button>
                            </div>
                        </div>

                        <!-- Desktop version of profile action buttons -->
                        <div class="editProfileButtonsContainer" *ngIf="currentState === ProfileState.Viewing || currentState === ProfileState.DeletingProfile">

                                <!-- Same buttons as above but with 'wide' class -->
                                <button mat-button style="color:white" class="btn btn-editProfileButton" (click)="editProfile()" id="buttonDisappearEdit" [ngClass]="{'wide': true}">Edit Profile</button>
                                <button mat-button style="color:white" class="btn btn-changePasswordButton"(click)="changePassword()" id="buttonDisappearEdit" [ngClass]="{'wide': true}" [disabled]="profileForm.get('isGoogleAuth')?.value === true">Change Password</button>
                                <button mat-button style="color:white" class="btn btn-billingDetailsButton"id="buttonDisappearEdit" [ngClass]="{'wide': true}" matTooltip="For Stripe Integration">Billing Details</button>
                                <button mat-button style="color:white" class="btn btn-cancelSubscriptionButton" (click)="deleteProfile()" id="buttonDisappearEdit" [ngClass]="{'wide': true}">Cancel Subscription</button>
                                <button mat-button style="color:white" class="btn btn-signOutButton" (click)="logOut()" id="buttonDisappearEdit" [ngClass]="{'wide': true}">Log Out</button>
                        </div>

                     </div>

                <div class="currentState" [ngSwitch]="currentState">

                  <!-- Profile data display in Viewing State -->
                  <ng-container *ngSwitchCase="ProfileState.Viewing">
                    <div class="profileDataContainer">

                        <!-- Display fields for name, email, DOB, gender, etc. -->
                        <h3 class="profileDetails name"><span class="spanProfileCategory">Name</span> <br> <span class="nameSpan">{{currentUser.name}}</span></h3>
                        <h3 class="profileDetails email"><span class="spanProfileCategory">Email Address</span> <br>  <span class="emailSpan">{{currentUser.email}}</span></h3>
                        <h3 class="profileDetails DOB" *ngIf="currentUser.dateOfBirth"><span class="spanProfileCategory">Date Of Birth</span> <br>{{currentUser.dateOfBirth}}</h3>

                        <!-- Additional fields with conditional display -->
                        <h3 class="profileDetails gender" *ngIf="currentUser.gender"><span class="spanProfileCategory">Gender</span> <br> {{currentUser.gender}}</h3>
                        <h3 class="profileDetails weight" *ngIf="currentUser.weight"><span class="spanProfileCategory">Weight</span> <br> {{currentUser.weight}}lbs</h3>
                        <h3 class="profileDetails height" *ngIf="currentUser.height"><span class="spanProfileCategory">Height</span> <br> {{displayHeight}}</h3>
                        <h3 class="profileDetails objective" *ngIf="currentUser.goals"><span class="spanProfileCategory">Objective</span> <br> {{currentUser.goals}}</h3>

                        <!-- Plan information and pricing -->
                        <div class="planContainer">
                            <h3 class="profileDetails plan" *ngIf="currentUser.tier === 'Just Looking'"><span class="spanProfileCategory">Plan</span> <br> {{currentUser.tier}}</h3>
                            <h3 class="profileDetails" *ngIf="currentUser.tier === 'All In' || currentUser.tier === 'Motivated'"><span class="spanProfileCategory">Plan</span> <br> {{currentUser.tier}}</h3>
                            <button mat-button style="color:white" class="btn-change" [routerLink]="['/change-plan/', currentUser.userId]">Change</button>
                        </div>
                        <h3 class="profileDetails" *ngIf="!freeTier"><span class="spanProfileCategory">Plan Pricing</span> <br> $<span class="planPricing">{{currentUser.price}}</span>/{{monthOrYear}}</h3>
                        <h3 class="profileDetails" *ngIf="freeTier"><span class="spanProfileCategory">Plan Pricing</span> <br> Free</h3>
                    </div>
                </ng-container>

                <!-- Profile form in Editing Profile State -->
                <ng-container *ngSwitchCase="ProfileState.EditingProfile">
                    <div class="profileDataContainer">
                        <form [formGroup]="profileForm" (ngSubmit)="saveProfile()" id="profileForm">
                            <div class="updateProfile">

                                <!-- Form fields for each profile attribute with validation -->
                                <h3 class="profileDetailsInput name">
                                        <span class="spanProfileCategory name" [ngStyle]="getLabelStyle('name')">
                                            <span>Name</span>
                                            <label for="error"
                                                id="error"
                                                *ngIf="shouldShowError('name')"
                                                class="error-alert">{{getErrorMessage('name')}}</label>
                                        </span><br>
                                        <input class="name" matInput placeholder="Enter Full Name" name="name" 
                                        formControlName="name"
                                        type="text"
                                        name="name"
                                        trimOnBlur
                                        required 
                                        [ngStyle]="getInputStyle('name')"
                                        [ngClass]="{'error-input': shouldShowError('name')}">
                                </h3>

                                <!-- Similar input fields for email, DOB, gender, weight, height, objective -->
                                <h3 class="profileDetailsInput email">
                                    <span class="spanProfileCategory email" [ngStyle]="getLabelStyle('email')">Email Address
                                        <label for="error" 
                                            id="error" 
                                            *ngIf="shouldShowError('email')" 
                                            class="error-alert">{{getErrorMessage('email')}}</label>
                                    </span><br>
                                    <input class="email" matInput placeholder="Enter Email" 
                                           name="email"
                                           type="email"
                                           formControlName="email"
                                           [attr.disabled]="profileForm.get('email')?.disabled ? '' : null"
                                           (blur)="checkEmail($event)"
                                           trimOnBlur
                                           [ngStyle]="getInputStyle('email')"
                                           [ngClass]="{'error-input': shouldShowError('email')}"
                                           required>
                                </h3>

                                <h3 class="profileDetailsInputDOB">
                                    <div class="dateOfBirthSpanAndErrorContainer">
                                        <span class="spanProfileCategoryDOB" [ngStyle]="getLabelStyle('dateOfBirth')">Date Of Birth
                                            <label for="error" 
                                                id="error" 
                                                *ngIf="shouldShowError('dateOfBirth')" 
                                                class="error-alert">{{getErrorMessage('dateOfBirth')}}</label>
                                        </span><br>
                                    </div>
                                    <input placeholder="mm/dd/yyyy" matInput name="dateOfBirth"
                                            type="text"
                                            formControlName="dateOfBirth"
                                            (blur)="validateAge()"
                                            pattern="^(0[1-9]|1[0-2])\/(0[1-9]|[12][0-9]|3[01])\/([0-9]{4})$"
                                            maxlength="10" 
                                            [ngStyle]="getInputStyle('dateOfBirth')"
                                            [ngClass]="{'error-input': shouldShowError('dateOfBirth')}">
                                </h3>
                                 
                                <h3 class="profileDetailsInputGender">
                                    <span class="spanProfileCategory">Gender</span><br>
                                    <select class="gender" matNativeControl name="gender" formControlName="gender">
                                        <option value="" disabled selected>Select Gender</option>
                                        <option value="Male">Male</option>
                                        <option value="Female">Female</option>
                                    </select>
                                </h3>

                                <h3 class="profileDetailsInputWeight">
                                    <span class="spanProfileCategory" [ngStyle]="getLabelStyle('weight')">Weight
                                        <label for="error" 
                                            id="error" 
                                            *ngIf="shouldShowError('weight')" 
                                            class="error-alert">{{getErrorMessage('weight')}}</label>
                                    </span><br>
                                    <input matInput placeholder="Enter Weight in lbs (e.g., 245)" min="50" 
                                            type="decimal"
                                            formControlName="weight"
                                            max="600"  name="weight" type="text"
                                            pattern="^\d+(\.\d{1,2})?$" 
                                            step="0.01" 
                                            (blur)="isWeightValid()"
                                            [ngStyle]="getInputStyle('weight')"
                                            [ngClass]="{'error-input': shouldShowError('weight')}">
                                </h3>
                                
                                <h3 class="profileDetailsInputHeight">
                                    <span class="spanProfileCategory" [ngStyle]="getLabelStyle('height')">Height
                                        <label for="error" 
                                            id="error" 
                                            *ngIf="shouldShowError('height')" 
                                            class="error-alert">{{getErrorMessage('height')}}</label>
                                    </span><br>
                                    <input matInput 
                                           placeholder="Enter Height (e.g., 6.5 or 6'6&quot;)" 
                                           name="height"
                                           formControlName="height"
                                           (input)="onHeightInput($event)"
                                           [ngStyle]="getInputStyle('height')"
                                           [ngClass]="{'error-input': shouldShowError('height')}">
                                </h3>

                                <h3 class="profileDetailsInputObjective">
                                    <span class="spanProfileCategory">Objective</span><br>
                                    <select class="goals" matNativeControl name="goals" formControlName="goals">
                                        <option value="" disabled selected>Select Objective</option>
                                        <option value="Lose Fat">Lose Fat</option>
                                        <option value="Maintain Weight">Maintain Weight</option>
                                        <option value="Build Muscle">Build Muscle</option>
                                    </select>
                                </h3>

                            </div>

                            <div class="updateProfileButtonContainer" [ngClass]="{'wide': true}">
                                <button mat-button style="color:white" class="btn btn-cancelProfileButton" type="button" (click)="cancelAction()">Cancel</button>
                                <button mat-button style="color:white" class="btn btn-updateProfileButton" 
                                type="submit" [disabled]="!isFormValid('profile')" (click)="saveProfile()">Update</button>
                            </div>
                        </form>
                    </div>
                </ng-container>

                <!-- Deleting Profile State -->
                <ng-container *ngSwitchCase="ProfileState.DeletingProfile">
                    <div class="profileDataContainer">
                        <h3 class="profileDetails name"><span class="spanProfileCategory">Name</span> <br> {{currentUser.name}}</h3>
                        <h3 class="profileDetails email"><span class="spanProfileCategory">Email Address</span> <br> {{currentUser.email}}</h3>
                        <h3 class="profileDetails" *ngIf="currentUser.dateOfBirth"><span class="spanProfileCategory">Date Of Birth</span> <br>{{currentUser.dateOfBirth}}</h3>
                        <h3 class="profileDetails" *ngIf="currentUser.gender"><span class="spanProfileCategory">Gender</span> <br> {{currentUser.gender}}</h3>
                        <h3 class="profileDetails" *ngIf="currentUser.weight"><span class="spanProfileCategory">Weight</span> <br> {{currentUser.weight}}lbs</h3>
                        <h3 class="profileDetails" *ngIf="currentUser.height"><span class="spanProfileCategory">Height</span> <br> {{currentUser.height}}ft</h3>
                        <h3 class="profileDetails" *ngIf="currentUser.goals"><span class="spanProfileCategory">Objective</span> <br> {{currentUser.goals}}</h3>
                        <div class="planContainer">
                            <h3 class="profileDetails plan" *ngIf="currentUser.tier"><span class="spanProfileCategory">Plan</span> <br> {{currentUser.tier}}</h3>
                            <button mat-button style="color:white" class="btn-change" [routerLink]="['/change-plan/', currentUser.userId]">Change</button>
                        </div>
                        <h3 class="profileDetails" *ngIf="!freeTier"><span class="spanProfileCategory">Plan Pricing</span> <br> ${{currentUser.price}}/{{monthOrYear}}</h3>
                    </div>
                </ng-container>

                <!-- Picture form in Changing Picture State -->
                <ng-container *ngSwitchCase="ProfileState.ChangingPicture"> 
                    <div class="profilePictureFormContainer">
                    <form [formGroup]="pictureForm" (ngSubmit)="saveProfilePicture()">
                      <div class="profilePictureLinkContainer">
                        <h3 class="profileDetailsInputPhoto"><span class="spanProfileCategory" [ngStyle]="getLabelStyle('imgUrl')">Profile Picture
                            <label for="error" 
                                            id="error" 
                                            *ngIf="shouldShowError('imgUrl')" 
                                            class="error-alert">{{getErrorMessage('imgUrl')}}</label>
                        </span></h3>

                        <div class="imageInputContainer">

                            <!-- URL input field -->
                            <input matInput 
                                #urlInput
                                class="imgUrl" 
                                placeholder="Paste Image Url"
                                type="text" 
                                [ngStyle]="getInputStyle('imgUrl')"
                                [ngClass]="{'error-input': shouldShowError('imgUrl')}"
                                formControlName="imgUrl" 
                                (input)="onImageUrlInput($event)"
                                (paste)="onUrlPaste($event)"
                                pattern="https?://.+"
                                matTooltip="Paste Image URLs here.
                                (Note: Paste URL + Save to Upload image)"
                                [matTooltipDisabled]="tooltipDisabled"
                                (mouseenter)="enableTooltip()"
                                (mouseleave)="disableTooltip()"
                                [disabled]="isUploading || isLoadingImages">  
                                
                            <!-- Hidden File Input -->
                            <input
                                #fileInput
                                type="file"
                                accept="image/*"
                                (change)="onFileSelected($event)"
                                style="display: none">

                            <!-- Paste URL Button --> 
                            <button mat-button
                                    class="pasteButton" (click)="pasteUrl()" 
                                    *ngIf="showButton"  [disabled]="isUploading || shouldShowLoadingOverlay"> Paste URL </button>   
                        
                            <!-- Upload button with progress spinner -->
                            <button mat-button 
                                class="uploadButton"
                                (click)="fileInput.click()"
                                [disabled]="isUploading || shouldShowLoadingOverlay"
                                type="button">
                            <span *ngIf="!isUploading">Upload</span>
                            <div *ngIf="isUploading" class="uploadingState">
                            <mat-spinner diameter="20" style="--mdc-circular-progress-active-indicator-color: black"></mat-spinner>
                            <span class="uploadProgress">{{uploadProgress | number:'1.0-0'}}%</span>
                            </div>
                            </button>

                        </div>
                      </div>

                      <!-- Save/Cancel Buttons -->
                      <div class="savePictureButtonContainer">
                        <button mat-button  class="btn btn-cancelPhotoButton" type="button" (click)="cancelAction()">{{ getCancelButtonText() }}</button>
                        <button mat-button  class="btn btn-savePhotoButton" type="submit" [disabled]="isUploading || !pictureForm.valid">
                            <ng-container *ngIf="!isSavingPicture">Save</ng-container>
                                <div *ngIf="isSavingPicture" class="savingState">
                                <mat-spinner diameter="16" 
                                            style="--mdc-circular-progress-active-indicator-color: white">
                                </mat-spinner>
                                </div>
                        </button>
                      </div>
                    </form>

                    <!-- Upload status messages -->
                    <div class="uploadInstructionsSuccessAndFailure">
                        <p class="uploadSuccess" [ngClass]="{'visible': showUploadSuccess && !externalUrlError}"><span class="uploadedSuccessSpan"><strong>Image Uploaded to View Only!</strong> &nbsp;</span> <br> <strong>Save</strong> to store.<strong>Cancel</strong> to discard.</p>
                        <p class="uploadFailure" [ngClass]="{'visible': externalUrlError && !showUploadSuccess}"><span class="uploadedFailureSpan"><strong>URL Access Denied!</strong> &nbsp;</span>Please proceed to download and upload the image.</p>
                        <p class="supportedFileTypes">Supported File Formats: .jpg, .jpeg, .png, .gif & .webp with file size of 5MB max. <br><br> Or, Paste Image URLs into the input field above and we'll save you a step.</p>
                    </div>
                </div> 
                </ng-container>

                <!-- Password form in Changing Password State -->
                <ng-container *ngSwitchCase="ProfileState.ChangingPassword">
                        <div class="updatePassword">
                            <h3 class="profileDetailsChangePassword"><span class="spanProfileCategory">Change Password</span> <br> </h3>
                            <form [formGroup]="passwordForm" (ngSubmit)="updateUserPassword()" id="passwordForm">
                                
                                <!-- Current password field -->
                                <div class="oldPassword">
                                    <div class="input-details">
                                        <label class="label" for="oldPassword" [ngStyle]="getLabelStyle('oldPassword')">Current Password</label>
                                        <label for="error" *ngIf="authenticating" class="authenticating">Authenticating</label>
                                        <label for="error" 
                                        id="error" 
                                        *ngIf="shouldShowError('oldPassword')" 
                                        class="error-alert">{{getErrorMessage('oldPassword')}}</label>
                                    </div>
                                    <div class="passwordInput">
                                        <input type="password"
                                            matInput
                                            id="oldPassword"
                                            formControlName="oldPassword"
                                            (blur)="checkOldPassword()"
                                            placeholder="Enter Current Password"
                                            required
                                            [ngStyle]="getInputStyle('password')"
                                            [ngClass]="{'error-input': shouldShowError('password')}">
                                        <fa-icon [icon]="oldPasswordVisible ? ['fas', 'eye-slash'] : ['fas', 'eye']" [ngStyle]="getInputStyle('oldPassword')" (click)="toggleOldPasswordVisibility()" class="eye-icon" appShowHidePassword [targetInputs]="['#oldPassword']"></fa-icon>        
                                    </div>
                                </div>   
                                
                                <!-- New password fields with group validation -->
                                <div formGroupName="passwordGroup">

                                    <!-- New password field -->
                                    <div>
                                        <div class="input-details passwordRelative">
                                            <label class="label" for="password" [ngStyle]="getLabelStyle('password')">New Password</label>
                                            <label for="error" 
                                                id="error" 
                                                *ngIf="shouldShowError('password')" 
                                                class="error-alert">{{getErrorMessage('password')}}</label>

                                            <!-- Password requirements popup -->
                                            <div class="popup" *ngIf="isPopupVisible">
                                                <p>Password must:</p>
                                                <ul>
                                                    <li>Be at least 8 characters long</li>
                                                    <li>Contain at least one uppercase letter</li>
                                                    <li>Contain at least one lowercase letter</li>
                                                    <li>Contain at least one number</li>
                                                    <li>Contain at least one special character (e.g., &#64;, #, $, etc.)</li>
                                                </ul>
                                            </div>
                                        </div>
                                        <div class="passwordInput">
                                            <input type="password"
                                                matInput
                                                id="password"
                                                (focus)="showPasswordPopup()"
                                                (blur)="hidePasswordPopup()"
                                                placeholder="Enter New Password"
                                                formControlName="password"
                                                required
                                                >
                                            <fa-icon [icon]="passwordVisible ? ['fas', 'eye-slash'] : ['fas', 'eye']" [ngStyle]="getInputStyle('password')" (click)="togglePasswordVisibility()" class="eye-icon" appShowHidePassword [targetInputs]="['#confirmPassword', '#password']"></fa-icon>
                                        </div>
                                    </div>

                                    <!-- Confirm password field -->
                                    <div>
                                        <div class="input-details focusedInput">
                                            <label class="label" for="confirmPassword" [ngStyle]="getLabelStyle('confirmPassword')">Confirm New Password</label>
                                            <label for="error" 
                                                id="error" 
                                                *ngIf="shouldShowError('confirmPassword')" 
                                                class="error-alert">{{getErrorMessage('confirmPassword')}}</label>
                                        </div>
                                        <div class="passwordInput">
                                            <input type="password"
                                                matInput
                                                id="confirmPassword"
                                                (focus)="showPasswordPopup()"
                                                (blur)="hidePasswordPopup(); checkPasswords()"
                                                placeholder="Confirm New Password"
                                                formControlName="confirmPassword"
                                                (copy)="preventCopyPaste($event)"
                                                (cut)="preventCopyPaste($event)" 
                                                (paste)="preventCopyPaste($event)"
                                                [ngStyle]="getInputStyle('confirmPassword')"
                                                [ngClass]="{'error-input': shouldShowError('confirmPassword')}"
                                                required
                                                [ngStyle]="{'border-color': passwordGroup.get('confirmPassword')?.invalid && (passwordGroup.get('confirmPassword')?.dirty || passwordGroup.get('confirmPassword')?.touched) ? 'red' : 'white'}">
                                            <fa-icon [icon]="passwordVisible ? ['fas', 'eye-slash'] : ['fas', 'eye']" [ngStyle]="getInputStyle('confirmPassword')" (click)="togglePasswordVisibility()" class="eye-icon" appShowHidePassword [targetInputs]="['#confirmPassword', '#password']"></fa-icon>
                                        </div>
                                    </div>
                                </div>

                                <!-- Submit buttons -->
                                <div class="updatePasswordButtonContainer">
                                    <button mat-button style="color:white" class="btn btn-cancelPasswordButton" type="button" (click)="cancelAction()">Cancel</button>
                                    <button mat-button style="color:white" class="btn btn-updatePasswordButton" form="passwordForm" 
                                    type="submit" [disabled]="!isFormValid('password')" (click)="updateUserPassword()">Change</button>
                                </div>
                            </form>
                        </div>
                    </ng-container>
                </div>
              </div>

              <!-- Mobile-specific buttons for profile editing -->
              <div class="updateProfileButtonContainerMobile" [ngClass]="{'narrow': true}" *ngIf="currentState === ProfileState.EditingProfile">
                <button mat-button style="color:white" class="btn btn-cancelProfileButton mobile" type="button" (click)="cancelAction()">Cancel</button>
                <button mat-button style="color:white" class="btn btn-updateProfileButton mobile" form="profileForm" 
                type="submit" [disabled]="!isFormValid('profile')" (click)="saveProfile()">Update</button>
            </div>

            </mat-card>  
        </fieldset> 
        </div>  
    </div>

</div>

